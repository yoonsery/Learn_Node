## Authentication

### ì¸ì¦ì´ë€?

- you are who you say you are
- password, pin-codeë¡œ ì¸ì¦ `You know` â†’ client
- mobile phone, hardware token `You have`
- fingerprints, signature `You are` â†’ server

httpëŠ” stateless protocol ì¸ë° ì–´ë–»ê²Œ AUTH happen?

- ì‚¬ìš©ìëŠ” id, passwordë¥¼ í†µí•´ ì„œë²„ì— ê°€ì…
- ì„œë²„ì— ì‚¬ìš©ìì— ëŒ€í•œ ì •ë³´ë¥¼ ì €ì¥ (id, pw) í•´ë‘ë©´ ë‚˜ì¤‘ì— ì‚¬ìš©ìì˜ id, pwë¡œ ë¡œê·¸ì¸ì„ í•  ìˆ˜ ìˆë‹¤
- ë¡œê·¸ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ë˜ì—ˆë‹¤ë©´, ë‹¤ìŒì˜ ì‚¬ìš©ìê°€ ë‹¤ë¥¸ ë¦¬í€˜ìŠ¤íŠ¸ë¥¼ í•  ë•Œ,  
  ì„œë²„ê°€ ì–´ë–»ê²Œ ì´ ì¶”ê°€ì ì¸ ìš”ì²­ì„ í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì¸ì§€ ì•„ë‹Œì§€ êµ¬ë¶„í•˜ëŠ”ê°€? âŸ¶ 2ê°€ì§€ ë°©ë²•ì´ ìˆë‹¤

### Session & Cookies

#### User Sessions

ì‚¬ìš©ìì˜ sessionì„ ì„œë²„ì—ì„œ ë³´ê´€  
í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ë¡œê·¸ì¸ => ì„œë²„ëŠ” ì‚¬ìš©ìì˜ DBì— ìˆëŠ” id, pwê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸  
=> ì¡´ì¬í•˜ëŠ”, ìœ íš¨í•œ ì‚¬ìš©ìë¼ë©´ ì„¸ì…˜ì„ ë§Œë“ ë‹¤ - ì„¸ì…˜ì—ëŠ” userId, sessionId, expiration(ì„¸ì…˜ì´ ì–¼ë§ˆë™ì•ˆ ìœ íš¨í•œì§€)ì´  
=> ì´ ì„¸ì…˜ì˜ ì •ë³´ë¥¼ ë³„ë„ì˜ sessionì´ë¼ëŠ” Databaseì— ì €ì¥í•œë‹¤ (DB | FileSystem | memory ì¼ ìˆ˜ ìˆë‹¤)  
=> í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì„¸ì…˜ê³¼ ê´€ë ¨ëœ ì •ë³´ë¥¼ (ëŒ€ì²´ë¡œ) ì¿ í‚¤ì— ë„£ì–´ì„œ ë³´ë‚´ì¤€ë‹¤ `HTTP only`ë¼ëŠ” ì˜µì…˜ì„ ì£¼ë©´  
=> í•´ë‹¹ ì¿ í‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ì˜í•´ì„œë§Œ ì½ì„ ìˆ˜ ìˆë‹¤ (JSë‚˜ í”„ë¡œê·¸ë¨ë‚´ì—ì„œëŠ” ë³¼ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì•ˆì „)  
=> í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ë‹¤ë¥¸ ìš”ì²­ì„ í•  ë•Œ ì´ ì¿ í‚¤ì˜ ì •ë³´(ì„¸ì…˜ id)ë¥¼ ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ í¬í•¨í•´ ì¤€ë‹¤  
=> í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚´ì¤€ session idë¥¼ í†µí•´ì„œ ì„¸ì…˜ DBì— ì¡´ì¬í•˜ëŠ” session id ì¸ì§€, ë§Œë£Œëœ ê±´ ì•„ë‹Œì§€ ê²€í† í•œ ë‹¤ìŒ  
=> ìœ íš¨í•˜ë‹¤ë©´ session idë¥¼ í†µí•´ì„œ ì‚¬ìš©ìê°€ ëˆ„êµ¬ì¸ì§€ íŒŒì•…í•´ì„œ, ê´€ë ¨ëœ ë°ì´í„°ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë³´ë‚´ì¤„ ìˆ˜ ìˆë‹¤

- User Sessions ì¥ì 

  - session DBì— ì„¸ì…˜ì— ëŒ€í•œ ì •ë³´ë¥¼ ë³´ê´€í•˜ê³  ìˆìœ¼ë¯€ë¡œ ì‹ ë¢°í•  ìˆ˜ ìˆë‹¤, TRUSTED
  - ì¿ í‚¤ì‚¬ìš©ìœ¼ë¡œ ì„œë²„ì—ì„œ ë³´ë‚´ê¸°ë„ ì‰½ê³  í´ë¼ì´ì–¸íŠ¸ê°€ ë³„ë„ ì²˜ë¦¬í•  ì¼ ì—†ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì•Œì•„ì„œ í•´ê²°í•´ì„œ ê°„ë‹¨í•˜ê³  ì‹¬í”Œí•¨, MAKE IT EASY
  - HTTP Only ì˜µì…˜ì„ ì‚¬ìš©í•  ê²½ìš° ì•ˆì „í•˜ê³  ë³´ì•ˆì„±ì´ ë†’ë‹¤
  - ì‚¬ìš©ìì— ëŒ€í•œ ì •ë³´ê°€ ì•„ë‹ˆë¼ session Idì— ëŒ€í•´ì„œ ë³´ë‚´ë¯€ë¡œ ì•ˆì „ì„±ì´ ë†’ë‹¤

- User Sessions ë‹¨ì 
  - Stateful : ì„œë²„ì—ì„œ ì‚¬ìš©ìì— ëŒ€í•œ ì •ë³´ë¥¼ sessionì— ë³´ê´€ => ì„œë²„ì— stateê°€ ìˆë‹¤
  - í•œ ì„œë²„ì— ì„¸ì…˜ì„ ë³´ê´€í•˜ê³  ìˆìœ¼ë¯€ë¡œ ë§ì€ ì„œë²„ë“¤ì´ ì„¸ì…˜ì˜ ì •ë³´ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ í•˜ë‚˜ì˜ ì„œë²„ì— ì ‘ì†í•´ì„œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ í•´ì•¼í•œë‹¤  
    => í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ì—¬ëŸ¬ê°€ì§€ ë„¤íŠ¸ì›Œí¬ìš”ì²­ì„ í•´ì•¼í•˜ë¯€ë¡œì¨ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆë‹¤

### JWT

#### Using JWT

JWT - JSON Web Token, JSONì„ ì´ìš©í•´ ì›¹ í† í°ì„ ì£¼ê³  ë°›ëŠ” ê²ƒ  
JSONì´ë¼ëŠ” ì˜¤ë¸Œì íŠ¸ ë² ì´ìŠ¤ ì•ˆì— `Header`, `Payload`, `signature` 3ê°€ì§€ë¡œ ë‚˜ëˆ ì ¸ìˆë‹¤

- **Header** : ì‚¬ìš©í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ê³¼ íƒ€ì…ì— ëŒ€í•´ ëª…ì‹œ
- **Payload** : ì „ì†¡í•˜ê³  ì£¼ê³ ë°›ê³  ì‹¶ì€ ë‹¤ì–‘í•œ ë°ì´í„°ë“¤ì´ í¬í•¨ - ì¸ì½”ë”©ë˜ì–´ì„œ ë³´ì•ˆì²˜ë¦¬ë¨
- **signature** : ì¸ì½”ë”©í•œ header, payload ë¿ë§Œ ì•„ë‹ˆë¼ ì´ê²ƒì„ ì¸ì½”ë”©í•˜ê¸° ìœ„í•´ì„œ ì‚¬ìš©í•˜ëŠ” ì„œë²„ì˜ ë¹„ë°€í‚¤ (= secret)ì´ë¼ëŠ” ê²ƒì„ ì´ìš©í•´ì„œ  
  í•¨ê»˜ ì¸ì½”ë”©ì„ í•´ë†“ìŒ => ì„œë²„ì—ì„œë§Œ ì•Œê³ ìˆê³  ì„œë²„ì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” ì‹œí¬ë¦¿ê³¼ í•¨ê»˜ ì¸ì½”ë”©í•œë‹¤
  - ì‚¬ìš©ìê°€ ì•…ì˜ì ìœ¼ë¡œ payloadì˜ ì •ë³´ë¥¼ ë°”ê¾¼ë‹¤ë©´, signatureì— ìˆëŠ” ì •ë³´ë¥¼ í†µí•´ì„œ í•´ë‹¹ë‚´ìš©ì˜ ë³€ê²½ì—¬ë¶€ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤

secretì„ í†µí•´ì„œ ì¸ì½”ë”©ì„ í•˜ë¯€ë¡œ ì •ë³´ì˜ ìœ íš¨ì„±ì„ í™•ì¸í•  ìˆ˜ ìˆê³  ì•ˆì „í•˜ë‹¤

ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ê³  ìœ íš¨í•œ ì‚¬ìš©ìë¼ë©´, ì‚¬ìš©ìì˜ idì™€ ì›í•˜ëŠ” ì •ë³´ë¥¼ í•¨ê»˜ ë¬¶ì–´ì„œ JWTë¥¼ ë§Œë“ ë‹¤ (Create JWT) - userId, claims, expiration  
=> JWTë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ë‚´ì¤€ë‹¤ => ì¶”í›„ì— ì¼ì–´ë‚˜ëŠ” ìš”ì²­ì€ headerì— JWTë¥¼ í¬í•¨í•´ì„œ ìš”ì²­í•¨  
=> ì„œë²„ì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°›ì€ JWTë¥¼ ìœ íš¨í•œì§€, ìˆ˜ì •ë˜ì—ˆëŠ”ì§€, ë§Œë£Œë˜ì—ˆëŠ”ì§€.. ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•˜ê³  (Verify JWT)  
=> í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë³´ë‚´ì¤€ë‹¤

- JWTì˜ ì¥ì 

  - No State
  - stateê°€ ì—†ìœ¼ë¯€ë¡œ ì„œë²„ê°„ì˜ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ í†µí•œ ì‚¬ìš©ìê²€ì¦ì´ í•„ìš”ì—†ë‹¤ - secret key ë§Œ ê°€ì§€ê³  ìˆìœ¼ë©´ ëœë‹¤

- JWTì˜ ë‹¨ì 
  - { JWT } : JWT ìì²´ê°€ ë‹¨ì ì´ ë  ìˆ˜ ìˆë‹¤
  - ë§Œì•½ ë§Œë£Œê¸°ê°„ì´ ì—†ëŠ” JWTë¥¼ ì£¼ê³  ë°›ëŠ”ë‹¤ë©´ - í•´ì»¤ê°€ JWTë¥¼ ê°€ì ¸ê°€ì„œ ì•…ìš©í•  ìˆ˜ ìˆë‹¤

## JWT ì‚¬ìš©í•˜ê¸° [ğŸ‘€](https://jwt.io/)

`npm i jsonwebtoken` ì„¤ì¹˜

```js
const token = jwt.sign(
  //1. payloadì—ëŠ” í•„ìˆ˜ì ì¸ ë‚´ìš©ë“¤ë§Œ ë‹´ëŠ”ë‹¤
  {
    id: 'userId',
    isAdmin: true, // isAdmin_ì‚¬ìš©ìì˜ ì—­í• ì— ëŒ€í•´ ì „ë‹¬
  },
  // 2. secret key ëŠ” ëŒ€ê°œ 32 character (32byte), pw generatorë¡œ ì„ì˜ë¡œ ìƒì„±..
  '3H5anIHK]%0}3ixU7)s1n$(05jJk)GT5'
);

console.log(token); // ì´ ê°’ì„ ë³µì‚¬í•œ í›„ ê³µì‹ì‚¬ì´íŠ¸ì—_ğŸ‘€ ê°€ë©´ tokení•´ë…ì´ ê°€ëŠ¥í•¨
```

decoded ëœ ë‚´ìš©ì„ ë³¼ ìˆ˜ëŠ” ìˆì§€ë§Œ ë§Œì•½ ê°’ì„ ë³€ê²½í•˜ë©´ í† í°ì´ ë³€ê²½ë˜ê³  ì„œë²„ì—ì„œ ì‚¬ìš©ìê°€ í† í°ì„ ìˆ˜ì •í–ˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆë‹¤

```js
// ì‚¬ì´íŠ¸ì—ì„œ decoded ëœ ê°’ì„ ìˆ˜ì •í•˜ë©´ encoded ë˜ì—ˆë˜ í† í°ì´ ë³€ê²½ë¨ -> ê·¸ ê°’ì„ editedì— ë³€ìˆ˜ë¡œ ì§€ì •
const edited =
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6Im9uYSIsImlzQWRtaW4iOmZhbHNlLCJpYXQiOjE2MzA5MDgwNzF9.cTntKlgSCegyI_z9guTjg2R3FnYy7HFf-l7pog81r1o';

jwt.verify(edited, secret, (error, decoded) => {
  console.log(error, decoded);
}); // JsonWebTokenError : invalid signature ë¼ê³  ì—ëŸ¬ëœ¬ë‹¤

// ë³€ê²½ë˜ì§€ ì•Šì€ ì›ë˜ í† í°ì„ verifyí•˜ê³  decodedë¥¼ ì½˜ì†”ë¡œê·¸í•˜ë©´ payload ê°’ì„ ì¶œë ¥í•¨
const originalKey =
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6Im9uYSIsImlzQWRtaW4iOmZhbHNlLCJpYXQiOjE2MzA5MDgwNzF9.9i7SE2uxmsOQLnm35QNJgVJL5JEpFu5d6u3J6LhsbpU';

jwt.verify(originalKey, secret, (error, decoded) => {
  console.log(decoded);
});
```

#### ë§Œë£Œê¸°ëŠ¥ ì¶”ê°€

```js
const token = jwt.sign(
  {
    id: 'ona',
    isAdmin: false,
  },
  secret,
  { expiresIn: 2 } // 2ì´ˆì•ˆì— ë§Œë£Œ
);

// setTimeoutìœ¼ë¡œ 3ì´ˆ ë’¤ì— ê²€ì¦í•˜ë©´ ì´ë¯¸ ìœ íš¨ê¸°ê°„ì´ ë§Œë£Œë˜ì—ˆìœ¼ë¯€ë¡œ ì—ëŸ¬ê°€ ë°œìƒí•¨
// TokenExpiredError: jwt expired
setTimeout(() => {
  jwt.verify(token, secret, (error, decoded) => {
    console.log(error, decoded);
  });
}, 3000);
```

## bcrypt

password-hashing function íŒ¨ìŠ¤ì›Œë“œ ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜

ì–´ë–¤ ì•Œê³ ë¦¬ì¦˜ì„ ì¼ëŠ”ì§€ ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•œ ì •ë³´ `Alg` - ì–¼ë§ˆë‚˜ ë§ì€ ë³µì¡ë„ë¡œ ì•”í˜¸í™” í–ˆëŠ”ì§€ ì•”í˜¸í™”ì— ëŒ€í•œ ë¹„ìš© `Cost` -  
ë” ëœë¤í•œ ê²ƒë“¤ì„ ì´ìš©í•´ ì›í•˜ëŠ” ê¸¸ì´ë§Œí¼ ì•”í˜¸ë¥¼ ë³µì¡í•˜ê²Œ í•˜ëŠ” `Salt` - ì•”í˜¸í™”ëœ ì •ë³´ `Hash` ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤

ì•”í˜¸ë¥¼ hashingë§Œ í•  ìˆ˜ ìˆê³ , hashing ëœ ê²°ê³¼ë¥¼ ë‹¤ì‹œ íŒ¨ìŠ¤ì›Œë“œë¡œ ë§Œë“¤ ìˆ˜ëŠ” ì—†ë‹¤ (ì˜ˆ\_ê³„ë€ -> ì˜¤ë¯ˆë ›)  
ì•”í˜¸í™”í•  ë•Œ ëœë¤í•œ ë¬¸ìì—´ì„ ì´ìš©í•´ì„œ (Salt) ì•”í˜¸í™”ë¥¼ ì¢€ ë” ë³µì¡í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤

`npm view bcrypt` ì¹˜ë©´ [ê¹ƒí—™ë§í¬](https://github.com/kelektiv/node.bcrypt.js#readme) ë³¼ ìˆ˜ ìˆë‹¤
`npm i bcrypt`ë¡œ ì„¤ì¹˜

```js
// ì˜ˆì‹œëŠ” ë™ê¸°ì ì¸ ë°©ì‹ì¸ Syncë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ ì„œë²„ì—ì„œ êµ¬í˜„í•  ë•ŒëŠ” ë¹„ë™ê¸°ì ì¸ ë°©ì‹ìœ¼ë¡œ í•˜ì!
const bcrypt = require('bcrypt');

const password = 'abcd1234';
const hashed = bcrypt.hashSync(password, 10); // ê¸¸ì´ê°€ 10ê°œì¸ salt ì„¤ì •
console.log(`password: ${password}, hashed: ${hashed}`);

const result = bcrypt.compareSync('abcd1234', hashed);
console.log(result); // true
```

saltì˜ ë³µì¡ë„ê°€ ë†’ì•„ì§ˆìˆ˜ë¡ í•´ì‹œí•˜ëŠ”ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì´ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ëŠ˜ì–´ë‚œë‹¤  
ì•”í˜¸ê³„ì‚°ì€ CPUë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë¯€ë¡œ saltë¥¼ ì§€ë‚˜ì¹˜ê²Œ ê¸¸ê²Œ í•  í•„ìš”ì—†ë‹¤, ëŒ€ë¶€ë¶„ 8, 10 ~ 12ë¡œ í•œë‹¤  
[- salt ê¸¸ì´ë³„ ì„±ëŠ¥ ì¸¡ì •](https://auth0.com/blog/hashing-in-action-understanding-bcrypt/)
